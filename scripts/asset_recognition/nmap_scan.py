import nmap
import psycopg2

def scan_network():
    nm = nmap.PortScanner()
    nm.scan(hosts='192.168.1.0/24', arguments='-F')  # -F para un escaneo r√°pido de puertos
    hosts_info = []
    for host in nm.all_hosts():
        os_name = 'Unknown'
        hostname = nm[host].hostname() if 'hostname' in nm[host] else 'Unknown'
        hosts_info.append((host, os_name, hostname))
    return hosts_info

def store_assets(assets):
    conn = psycopg2.connect(
        dbname="project_db",
        user="acarriq",
        password="3432576",
        host="localhost",
        port="5433"
    )
    cur = conn.cursor()
    for asset in assets:
        cur.execute("""
            INSERT INTO assets (ip_address, os, hostname) 
            VALUES (%s, %s, %s) 
            ON CONFLICT (ip_address) 
            DO UPDATE SET os = EXCLUDED.os, hostname = EXCLUDED.hostname;
        """, asset)
    conn.commit()
    cur.close()
    conn.close()

if __name__ == "__main__":
    assets = scan_network()
    store_assets(assets)
    print("Assets scanned and stored successfully.")
