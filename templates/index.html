{% extends "base.html" %}

{% block title %}Inicio - Asset Vulnerability Management{% endblock %}

{% block content %}
    <h1>Asset Vulnerability Management</h1>
    <p>
        Esta herramienta integra el reconocimiento de activos y el análisis de vulnerabilidades usando un método de priorización para no centrarse en vulnerabilidades aisladas. Utiliza las herramientas Nmap, OpenVAS y Metasploit.
    </p>
    <p><strong>Último escaneo:</strong> <span id="lastScanTime">{{ last_scan if last_scan else 'No se ha realizado ningún escaneo aún' }}</span></p>
    <form id="scanForm" action="{{ url_for('run_pipeline') }}" method="post">
        <button id="startScanBtn" class="btn btn-primary" type="submit" {% if scan_status.scanning %}disabled{% endif %}>Iniciar Escaneo</button>
    </form>
    <div id="scanProgress" style="display: {{ 'block' if scan_status.scanning else 'none' }};">
        <h3>Progreso del Escaneo</h3>
        <p id="scanMessage">{{ scan_status.message }}</p>
        <div class="progress">
            <div id="scanProgressBar" class="progress-bar" role="progressbar" style="width: {{ scan_status.progress }}%;" aria-valuenow="{{ scan_status.progress }}" aria-valuemin="0" aria-valuemax="100">{{ scan_status.progress }}%</div>
        </div>
    </div>
    <script>
        var socket = io();

        socket.on('connect', function() {
            // Obtener el estado actual del escaneo al conectar
            socket.emit('get_scan_status');
        });

        socket.on('scan_update', function(data) {
            var progress = data.progress;
            document.getElementById('scanProgressBar').style.width = progress + '%';
            document.getElementById('scanProgressBar').ariaValueNow = progress;
            document.getElementById('scanProgressBar').textContent = progress + '%';
            document.getElementById('scanMessage').textContent = data.message;
            document.getElementById('scanProgress').style.display = 'block';
        });

        socket.on('scan_complete', function(data) {
            document.getElementById('scanMessage').textContent = 'Escaneo completado.';
            document.getElementById('startScanBtn').disabled = false;
            document.getElementById('scanProgressBar').style.width = '100%';
            document.getElementById('scanProgressBar').ariaValueNow = '100';
            document.getElementById('scanProgressBar').textContent = '100%';
            document.getElementById('lastScanTime').textContent = data.last_scan;
        });

        document.getElementById('scanForm').onsubmit = function(e) {
            e.preventDefault();
            var socket = io();
            document.getElementById('startScanBtn').disabled = true;
            document.getElementById('scanProgress').style.display = 'block';

            socket.emit('start_scan');
        };
    </script>
{% endblock %}
