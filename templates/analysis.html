{% extends "base.html" %}

{% block title %}Análisis del Último Escaneo{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Análisis del Último Escaneo</h1>
    <div class="form-group">
        <label for="analysis-view">Selecciona Vista:</label>
        <select id="analysis-view" class="form-control" onchange="changeView()">
            <option value="general" {% if selected_view == 'general' %}selected{% endif %}>General</option>
            {% for asset in assets %}
            <option value="{{ asset[0] }}" {% if selected_view == asset[0] %}selected{% endif %}>{{ asset[0] }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="analysis-container row">
        <div class="image-container col-md-6" style="margin-top: 20px;">
            <img id="cvssImage" src="{{ url_for('figures', filename=image_file) }}" alt="Distribución CVSS {{ selected_view | capitalize }}" class="img-fluid">
        </div>
        <div class="info-container col-md-6">
            <h2>Vulnerabilidades Detectadas: <span id="totalVulnerabilities">{{ cves|length }}</span></h2>
            <p>Tiempo de Escaneo: <span id="scanTime">{{ scan_time }}</span></p>
            <h3>CVEs Detectados</h3>
            <div style="overflow-y: auto; max-height: 400px;">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>CVSS Score</th>
                            <th>Correlation Risk</th>
                        </tr>
                    </thead>
                    <tbody id="cveTableBody">
                        {% for cve in cves %}
                        <tr style="background-color: {% if cve[2] >= 9 %}red{% elif cve[2] >= 7 %}orange{% elif cve[2] >= 4 %}yellow{% elif cve[2] > 0 %}green{% else %}grey{% endif %}; cursor: pointer;" onclick="window.location.href='{{ url_for('cve_details', result_id=cve[0]) }}'">
                            <td>{{ cve[1] }}</td>
                            <td>{{ cve[2] }}</td>
                            <td>{{ '%.2f' | format(cve[3]) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div style="clear: both;"></div>
<script>
    function changeView() {
        var selectedView = document.getElementById("analysis-view").value;
        window.location.href = "/analysis?view=" + selectedView;
    }
</script>
{% endblock %}
