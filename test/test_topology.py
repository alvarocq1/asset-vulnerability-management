import sys
import psycopg2
from datetime import datetime, timedelta

# Añade el directorio padre al sys.path
sys.path.append('..')

from src.config.config import *

# Configuración de PostgreSQL
conn = psycopg2.connect(
    dbname=DB_NAME,
    user=DB_USER,
    password=DB_PASSWORD,
    host=DB_HOST,
    port=DB_PORT
)

def store_task(task_id, ip):
    try:
        cur = conn.cursor()
        cur.execute("""
            INSERT INTO scan_tasks (task_id, ip_address)
            VALUES (%s, %s)
            ON CONFLICT (task_id)
            DO NOTHING;
        """, (task_id, ip))
        conn.commit()
        cur.close()
        print("Task almacenado correctamente.")
    except Exception as e:
        print(f"Error al almacenar task: {e}")

def store_scan_metadata(task_id, ip, start_time, end_time):
    try:
        cur = conn.cursor()
        cur.execute("""
            INSERT INTO scan_metadata (task_id, ip_address, start_time, end_time, scan_time)
            VALUES (%s, %s, %s, %s, %s);
        """, (task_id, ip, start_time, end_time, end_time - start_time))
        conn.commit()
        cur.close()
        print("Datos almacenados correctamente.")
    except Exception as e:
        print(f"Error al almacenar datos: {e}")

def main():
    task_id = 'test-task-id'
    ip = '192.168.1.1'
    start_time = datetime.now()
    end_time = start_time + timedelta(minutes=30)
    
    store_task(task_id, ip)
    store_scan_metadata(task_id, ip, start_time, end_time)

if __name__ == "__main__":
    main()
