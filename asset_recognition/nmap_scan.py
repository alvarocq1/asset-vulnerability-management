import nmap
import psycopg2

def scan_network():
    nm = nmap.PortScanner()
    nm.scan(hosts='192.168.1.0/24', arguments='-O')  # OpciÃ³n -O para detectar el sistema operativo
    assets = []
    for host in nm.all_hosts():
        os_info = nm[host]['osmatch'][0]['name'] if nm[host].has_key('osmatch') and len(nm[host]['osmatch']) > 0 else 'Unknown'
        assets.append((host, os_info))
    return assets

def store_assets(assets):
    conn = psycopg2.connect(
        dbname="tfg_db",
        user="acarriq",
        password="3432576",
        host="localhost",
        port="5432"
    )
    cur = conn.cursor()
    for asset in assets:
        cur.execute("""
            INSERT INTO assets (ip_address, os_info)
            VALUES (%s, %s)
            ON CONFLICT (ip_address)
            DO UPDATE SET os_info = EXCLUDED.os_info;
        """, asset)
    conn.commit()
    cur.close()
    conn.close()

if __name__ == "__main__":
    assets = scan_network()
    store_assets(assets)
    print("Assets scanned and stored successfully.")
