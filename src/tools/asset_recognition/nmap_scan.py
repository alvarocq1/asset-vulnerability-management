import nmap
import psycopg2
import os
import sys

# Asegurar que el script se ejecute desde el directorio correcto
script_dir = os.path.dirname(os.path.realpath(__file__))  # Ruta al directorio del script
project_root = os.path.abspath(os.path.join(script_dir, "../../../"))  # Asumimos que el script está en 'src/tools/asset_recognition/' y navegamos hacia el raíz del proyecto
sys.path.append(project_root)  # Añadimos el raíz del proyecto a sys.path

# Importar la configuración desde la ruta absoluta
from src.config.config import *

def check_root():
    if os.geteuid() != 0:
        print("Este script necesita ser ejecutado con permisos de root.")
        sys.exit(1)

def scan_network():
    nm = nmap.PortScanner()
    # Especificamos la red a escanear (ejemplo: 192.168.1.0/24)
    target_network = '192.168.1.0/24'
    hosts_info = []
    
    try:
        nm.scan(hosts=target_network, arguments='-O -F')  # -O para detectar el OS y -F para un escaneo rápido de puertos
    except nmap.PortScannerError as e:
        if 'requires root privileges' in str(e):
            print(f"Root privileges required for OS detection. Skipping OS detection")
            nm.scan(hosts=target_network, arguments='-F')  # Escaneo rápido de puertos sin detección de OS
        else:
            raise
    
    for host in nm.all_hosts():
        os_name = 'not detected'
        if 'osclass' in nm[host]:
            os_name = nm[host]['osclass'][0]['osfamily'] if 'osfamily' in nm[host]['osclass'][0] else 'not detected'
        elif 'osmatch' in nm[host] and len(nm[host]['osmatch']) > 0:
            os_name = nm[host]['osmatch'][0]['name']
        
        hostname = nm[host].hostname() if 'hostname' in nm[host] else 'Unknown'
        hosts_info.append((host, os_name, hostname))
        print(f"Host: {host} | OS: {os_name} | Hostname: {hostname}")
    
    return hosts_info

def store_assets(assets):
    try:
        conn = psycopg2.connect(
            dbname=DB_NAME,
            user=DB_USER,
            password=DB_PASSWORD,
            host=DB_HOST,
            port=DB_PORT
        )
        print("Database connection successful")
    except Exception as e:
        print(f"Database connection failed: {e}")
        return
    
    try:
        cur = conn.cursor()
        for asset in assets:
            cur.execute("""
                INSERT INTO assets (ip_address, os, hostname) 
                VALUES (%s, %s, %s) 
                ON CONFLICT (ip_address) 
                DO UPDATE SET os = EXCLUDED.os, hostname = EXCLUDED.hostname;
            """, asset)
        conn.commit()
        cur.close()
    except Exception as e:
        print(f"Error storing assets: {e}")
    finally:
        conn.close()

if __name__ == "__main__":
    check_root()
    assets = scan_network()
    store_assets(assets)
    print("Assets scanned and stored successfully.")
